<script>
import { mapGetters } from 'vuex'
import { get, isNil } from 'lodash'

export default {
  props: {
    asset: {
      type: Object,
      required: true
    },
    to: {
      validator: (value) => {
        if (isNil(value)) return true
        return typeof value === 'string' || typeof value === 'object'
      },
      default: () => null
    },
    showRatings: {
      type: Boolean,
      default: true,
    }
  },
  data () {
    return {}
  },
  computed: {
    customLink () {
      return this.to
    },
    hasListeners () {
      return Object.keys(this.$listeners).length > 0
    },
    categoryName () {
      const a = this.asset // cf. docs about using lodash and Vue reactivity
      return get(a, 'category.name')
    },
    ...mapGetters([
      'baseImageRatio',
      'getBaseImageUrl',
    ])
  }
}
</script>

<template>
  <div
    v-if="asset.id"
    class="anchor-text--reset asset-card-container"
  >
    <QCard
      flat
      class="asset-card cursor-pointer"
      :tabindex="hasListeners ? '0' : false"
      v-on="$listeners"
    >
      <slot
        :asset="asset"
        name="image"
      >
        <QImg
          class="asset-image"
          :src="getBaseImageUrl(asset)"
          :alt="asset.name"
          :ratio="baseImageRatio"
        >
          <slot name="caption" />
        </QImg>
      </slot>

      <QCardSection class="asset-content q-py-xs q-px-sm">
        <slot :asset="asset">
          <h2 class="text-body1 text-weight-medium q-ma-none ellipsis">
            {{ asset.name }}
          </h2>
          <div class="row justify-between">
            <div class="text-subtitle2 asset-location text-grey-6 ellipsis">
              <AppRatingStars
                v-if="showRatings"
                :target="asset"
                readonly
              />
              <div v-else>
                {{ asset.locationName }}
              </div>
            </div>
            <div
              v-if="asset.price"
              class="text-weight-bold text-grey-8 ellipsis"
            >
              {{ $t({ id: 'pricing.price_per_time_unit_short_label' }, { price: $fx(asset.price), timeUnit: asset.timeUnit }) }}
            </div>
            <!-- <h3 class="text-subtitle2 text-weight-medium text-grey-6 q-ma-none text-right ellipsis">
              {{ categoryName }}
            </h3> -->
          </div>
          <slot name="bottom" />
        </slot>
      </QCardSection>
    </QCard>
  </div>
</template>

<style lang="stylus" scoped>
.asset-card-container
  max-width: 100%

.asset-card
  max-width: 100%
  &:focus, &:hover
    outline: none
    &::-moz-focus-inner
      border: 0
    .asset-image
      transform: translateZ(0) scale(1.02)
    .asset-content
      transform: translateY(5px)

.asset-image, .asset-content
  transition: all $transition-duration

.asset-card .asset-image
  border-radius: $generic-border-radius

.asset-location
  flex: 1 0
</style>

<style lang="stylus">
// caption slot
.asset-image .mission-status-triangle
  position: absolute
  bottom: 0
  right: 0
  padding: 0
  border-width: 2.5rem
  border-color: transparent $positive transparent transparent
  border-right-style: solid
  border-top-style: solid
  opacity: 0.8
  background: none // quasar override
  &.-busy
    border-color: transparent $warning transparent transparent
  &.-visitor-mission
    border-color: transparent $negative transparent transparent
</style>
